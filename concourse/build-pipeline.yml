---
resources:

- name: sourcecode
  type: git
  icon: github-circle
  source:
    uri: https://github.com/jjghali/concourse-multibranch.git
    branch: concourse-ci
    username: jjghali
    password: 76d09d8b28352cbf410f3c5359ce51ce173525b0

- name: docker-registry
  type: docker-image
  icon: docker
  source:
    repository: froggy-docker.jfrog.io/concourse-multibranch
    tag: test
    username: admin
    password: Rm8Oc1Xy2Qn2Fy

- name: npm-registry
  type: npm
  icon: npm
  source:
    package: cmbranch-cli
    username: admin
    registry: https://froggy.jfrog.io/froggy/api/npm/npm/
    token: YWRtaW46QVA2bk1GM1RCdDRrQ2J5dlRKVjNLUnZ0dzl1

resource_types:
- name: npm
  type: docker-image
  source:
    repository: nolan/concourse-npm-resource

jobs:
  - name: build-app    
    plan:
      - get: sourcecode
        trigger: true
      - task: build-node-app        
        config:
          platform: linux
          image_resource:
            type: registry-image
            source: { repository: node, tag: "10" }
          inputs:
            - name: sourcecode
          run:
            path: /bin/sh
            args:
              - -c
              - |
                cd sourcecode
                npm install
                npm run build            
          outputs:
          - name: artifact
            path: sourcecode/dist
          
      - put: npm-registry
        params:
          path: sourcecode
      
  - name: build-docker-image
    serial: true
    plan:
      - get: sourcecode
        trigger: true
      - put: docker-registry
        params:
          build: sourcecode